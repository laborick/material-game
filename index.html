<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">

<title>Material Atelier</title>

<style>

body{
 margin:0;
 background:#fafaf7;
 font-family:"Helvetica Neue","Yu Gothic","Hiragino Kaku Gothic ProN",sans-serif;
 text-align:center;
 color:#222;
}

h1{
 font-weight:300;
 letter-spacing:0.1em;
 margin:14px 0 2px;
 font-size:24px;
}

#mission{
 font-size:14px;
 letter-spacing:0.2em;
 color:#777;
 margin-bottom:6px;
}

#top{
 position:relative;
 width:360px;
 margin:0 auto;
}

#time{
 position:absolute;
 top:6px;
 left:50%;
 transform:translateX(-50%);
 font-size:18px;
 background:rgba(255,255,255,0.9);
 padding:4px 14px;
 border-radius:14px;
 box-shadow:0 0 3px rgba(0,0,0,0.1);
}

#score{
 font-size:18px;
 margin:6px 0;
}

#message{
 font-size:16px;
 margin:10px 12px;
 min-height:40px;
 color:#555;
 line-height:1.4;
}

canvas{
 background:#fff;
 border:1px solid #ddd;
 display:block;
 margin:0 auto;
 border-radius:8px;
}

button{
 margin:12px;
 padding:12px 28px;
 border:none;
 background:#333;
 color:#fff;
 border-radius:22px;
 font-size:15px;
 letter-spacing:0.08em;
}

button:active{
 opacity:0.7;
}

</style>
</head>

<body>

<h1>MATERIAL ATELIER</h1>
<div id="mission">ç´ æé›†ã‚</div>

<div id="score">
â˜ï¸ ç¶¿:0ã€€ğŸ‘ ç¾Šæ¯›:0ã€€ğŸŒ¿ éº»:0
</div>

<div id="message"></div>

<button id="startBtn">START</button>

<div id="top">
 <div id="time">25s</div>
 <canvas id="game" width="360" height="450"></canvas>
</div>

<script>

// =================
// Canvas
// =================
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");


// =================
// State
// =================
let state="ready";
let time=25;
let timer=0;
let parts=[];
let dominant=null;
let lastMsg="";

let score={
 cotton:0,
 wool:0,
 linen:0
};


// =================
// Avatar
// =================
const avatar={
 x:180,
 y:350
};


// =================
// Materials
// =================
const materials=[

{
 name:"cotton",
 label:"ç¶¿",
 emoji:"â˜ï¸",
 color:"#dbe8ff",
 msg:[
  "åŒ…å¸¯ã‚„ã‚¬ãƒ¼ã‚¼ã«ã‚‚ä½¿ã‚ã‚Œã‚‹å®‰å¿ƒç´ æã€‚",
  "æ±—ã‚’ã‚ˆãå¸ã£ã¦æ¯æ—¥ä½¿ãˆã‚‹å®šç•ªç´ æã€‚",
  "æ´—ã†ã»ã©è‚Œã«ãªã˜ã‚€å¤©ç„¶ç¹Šç¶­ã€‚"
 ]
},

{
 name:"wool",
 label:"ç¾Šæ¯›",
 emoji:"ğŸ‘",
 color:"#f0e4d0",
 msg:[
  "æ¹¿æ°—ã‚’é€ƒãŒã™å¤©ç„¶èª¿æ¹¿ç´ æã€‚",
  "ä¸€å¹´ä¸­ä½¿ãˆã‚‹ä¸‡èƒ½ç¹Šç¶­ã€‚",
  "ã—ã‚ã«ãªã‚Šã«ããé•·æŒã¡ã™ã‚‹ç´ æã€‚"
 ]
},

{
 name:"linen",
 label:"éº»",
 emoji:"ğŸŒ¿",
 color:"#e0f0df",
 msg:[
  "æ¯›ç¾½ãŒå°‘ãªãé€Ÿä¹¾æ€§ãŒé«˜ã„ç´ æã€‚",
  "ä½¿ã†ã»ã©é¢¨åˆã„ãŒå¢—ã™å¤©ç„¶ç¹Šç¶­ã€‚",
  "ã‚­ãƒƒãƒãƒ³ã§ã‚‚æ´»èºã™ã‚‹æ¸…æ½”ç´ æã€‚"
 ]
}

];


// =================
// Spawn
// =================
function spawn(){

 const m=materials[Math.floor(Math.random()*3)];

 parts.push({
  x:Math.random()*(canvas.width-30)+15,
  y:-20,
  v:2+Math.random()*2,
  mat:m
 });

}


// =================
// Draw Avatar
// =================
function drawAvatar(){

 ctx.fillStyle="#222";

 // head
 ctx.beginPath();
 ctx.arc(avatar.x,avatar.y-32,12,0,Math.PI*2);
 ctx.fill();

 // body
 ctx.fillRect(avatar.x-7,avatar.y-18,14,44);

 // arms
 ctx.fillRect(avatar.x-26,avatar.y-4,18,6);
 ctx.fillRect(avatar.x+8,avatar.y-4,18,6);

 // legs
 ctx.fillRect(avatar.x-7,avatar.y+24,7,26);
 ctx.fillRect(avatar.x+2,avatar.y+24,7,26);

}


// =================
// Funny Clothes
// =================
function drawClothes(){

 if(!dominant) return;

 ctx.fillStyle=dominant.color;

 // big jacket
 ctx.fillRect(avatar.x-18,avatar.y-22,36,34);

 // pocket
 ctx.fillStyle="#fff";
 ctx.fillRect(avatar.x-5,avatar.y-9,10,9);

 // mark
 ctx.font="11px serif";
 ctx.fillText(dominant.emoji,avatar.x-6,avatar.y-1);

 // shoulder
 ctx.fillStyle=dominant.color;
 ctx.fillRect(avatar.x-32,avatar.y-20,12,12);
 ctx.fillRect(avatar.x+20,avatar.y-20,12,12);

}


// =================
// Draw Part
// =================
function drawPart(p){

 ctx.font="22px serif";
 ctx.fillText(p.mat.emoji,p.x-8,p.y+8);

}


// =================
// Hit
// =================
function hit(p){

 return(
  p.x>avatar.x-24 &&
  p.x<avatar.x+24 &&
  p.y>avatar.y-42 &&
  p.y<avatar.y+46
 );

}


// =================
// Score
// =================
function updateScore(){

 document.getElementById("score").innerText=
 `â˜ï¸ ç¶¿:${score.cotton}ã€€ğŸ‘ ç¾Šæ¯›:${score.wool}ã€€ğŸŒ¿ éº»:${score.linen}`;

}


// =================
// Message
// =================
function showFinalMessage(mat){

 let pool=mat.msg.filter(m=>m!==lastMsg);

 let text=pool[Math.floor(Math.random()*pool.length)];

 lastMsg=text;

 document.getElementById("message").innerText=
 `ã€${mat.label}ã€‘${text}`;

}


// =================
// Loop
// =================
function loop(){

 ctx.clearRect(0,0,canvas.width,canvas.height);

 if(state==="playing"){

  drawAvatar();

  parts.forEach((p,i)=>{

   p.y+=p.v;

   drawPart(p);

   if(hit(p)){

    score[p.mat.name]++;
    updateScore();

    parts.splice(i,1);
   }

   if(p.y>500) parts.splice(i,1);

  });

  timer++;

  if(timer>42){
   spawn();
   timer=0;
  }

  if(time<=0){
   finish();
  }

 }

 if(state==="end"){

  drawAvatar();
  drawClothes();

 }

 requestAnimationFrame(loop);

}


// =================
// Timer
// =================
setInterval(()=>{

 if(state==="playing"){

  time--;

  document.getElementById("time").innerText=
   time+"s";

 }

},1000);


// =================
// Finish
// =================
function finish(){

 state="end";

 let max=0;

 materials.forEach(m=>{

  if(score[m.name]>max){
   max=score[m.name];
   dominant=m;
  }

 });

 if(dominant){
  showFinalMessage(dominant);
 }

}


// =================
// Control
// =================
let touch=false;

canvas.addEventListener("touchstart",()=>touch=true);
canvas.addEventListener("touchend",()=>touch=false);

canvas.addEventListener("touchmove",(e)=>{

 if(!touch) return;

 const r=canvas.getBoundingClientRect();

 avatar.x=
  e.touches[0].clientX-r.left;

});


// =================
// Start
// =================
document.getElementById("startBtn").onclick=()=>{

 state="playing";
 time=25;
 parts=[];
 timer=0;
 dominant=null;
 lastMsg="";

 score={
  cotton:0,
  wool:0,
  linen:0
 };

 updateScore();

 document.getElementById("message").innerText="";
 document.getElementById("time").innerText="25s";

};


loop();

</script>

</body>
</html>
